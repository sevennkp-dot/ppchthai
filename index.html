<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≤‡∏∞‡πÅ‡∏™‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{--bg:#f5f7fa;--primary:#1E3A8A;--accent:#0EA5E9;}
    html,body{height:100%;}
    body{background:linear-gradient(180deg,#f8fafc 0%, #fff 100%);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial;}
    .loading{display:inline-block;width:18px;height:18px;border:3px solid #f3f3f3;border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(-10px);top:18px;z-index:60;padding:10px 16px;border-radius:10px;color:white;font-weight:600;opacity:0;transition:all .28s ease;backdrop-filter: blur(4px)}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .pulse-highlight{animation:pulse 2s ease-in-out; border-color:#fde68a}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(253,230,138,0.0)}50%{box-shadow:0 6px 18px -6px rgba(253,230,138,0.6)}100%{box-shadow:0 0 0 0 rgba(253,230,138,0.0)}}
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
    body { display: flex; flex-direction: column; min-height: 100vh; }
  </style>
</head>
<body class="min-h-screen text-gray-800">

  <main class="w-full max-w-full md:max-w-2xl mx-auto p-4">

    <!-- Top header / brand -->
    <header class="mt-3 mb-3 flex items-center gap-3">
      <div class="w-12 h-12 rounded-3xl bg-[000000] flex items-center justify-center shadow-md">
        <img src="https://yoauscrafbucdahwlvmc.supabase.co/storage/v1/object/sign/pic/logo.png" class="w-24 h-24 object-contain" alt="logo"/>
      </div>
      <div>
        <h1 class="text-xl font-extrabold">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏õ.‡∏õ.‡∏ä</h1>
        <p class="text-sm text-gray-600">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏≤‡∏ö‡∏õ‡∏£‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</p>
      </div>
    </header>

    <!-- Primary card: emergency form -->
    <section id="reportCard" class="bg-white rounded-2xl shadow-2xl border border-gray-200 p-5 mb-5">
      <div class="mb-4">
        <h2 class="text-lg font-bold">‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏¥</h2>
        <p class="text-sm text-gray-600 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
      </div>

      <div class="p-4 rounded-2xl bg-gray-50 border border-gray-200 shadow-sm">

  <!-- Case ID Display moved to top -->
  <div class="p-4 mb-4 bg-blue-50 border border-blue-300 rounded-2xl shadow-sm">
    <label class="block text-sm font-semibold text-blue-900">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
    <div class="flex items-center gap-2 mt-2">
      <input id="caseIdDisplay" type="text" readonly class="flex-1 rounded-xl border px-4 py-2 bg-white font-semibold text-blue-700 shadow-sm" />
      <button type="button" id="copyCaseIdBtn" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
    </div>
    <input type="hidden" id="caseIdInput" name="case_id" />
  </div>

  <span class="block text-sm font-semibold text-gray-800">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà <span class="text-red-600">*</span></span>
  <div class="mt-2 flex flex-col gap-2">
    <label class="inline-flex items-center gap-2">
      <input type="radio" name="identify" value="yes" class="w-4 h-4" required>
      <span>‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</span>
    </label>
    <label class="inline-flex items-center gap-2">
      <input type="radio" name="identify" value="no" class="w-4 h-4">
      <span>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</span>
    </label>
  </div>

</div>

        
          <input type="hidden" id="caseIdInput" name="case_id" />
        </div>
      </div>

      <form id="emergencyForm" class="space-y-4 hidden" novalidate id="formContainer">

        <div>
          <label for="inputName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-600">*</span></label>
          <input id="inputName" name="name" type="text" required class="mt-1 block w-full rounded-2xl border px-4 py-3 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#1E3A8A]" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
        </div>

        <div>
          <label for="inputPhone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-600">*</span></label>
          <input id="inputPhone" name="phone" type="tel" inputmode="tel" pattern="[0-9+()\s-]{6,}" required class="mt-1 block w-full rounded-2xl border px-4 py-3 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#1E3A8A]" placeholder="08x-xxx-xxxx">
          <p class="text-red-600 text-sm mt-1 font-bold">** ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ **</p>
        </div>

        <div>
  <label class="block text-sm font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï <span class="text-red-600">*</span></label>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
    <div>
      <label class="text-sm">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
      <input id="villageInput" name="village" type="text" class="mt-1 block w-full rounded-2xl border px-4 py-3" placeholder="‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô">
    </div>
    <div>
      <label class="text-sm">‡∏ï‡∏≥‡∏ö‡∏•</label>
      <input id="subdistrictInput" name="subdistrict" type="text" class="mt-1 block w-full rounded-2xl border px-4 py-3" placeholder="‡∏ï‡∏≥‡∏ö‡∏•">
    </div>
    <div>
      <label class="text-sm">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
      <input id="districtInput" name="district" type="text" class="mt-1 block w-full rounded-2xl border px-4 py-3" placeholder="‡∏≠‡∏≥‡πÄ‡∏†‡∏≠">
    </div>
    <div>
      <label class="text-sm">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
      <input id="provinceInput" name="province" type="text" class="mt-1 block w-full rounded-2xl border px-4 py-3" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
    </div>
  </div>
</div>

        <!-- OpenAI Chatbot UI integrated -->
        <div>
          <label class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï (‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå)<span class="text-red-600">*</span></label>

          <div id="aiChatContainer" class="mt-3 w-full rounded-2xl border shadow-md overflow-hidden">
            <div class="w-full bg-white rounded-xl overflow-hidden flex flex-col h-[520px]">
              <header class="p-3 bg-indigo-600 text-white shadow-md">
                <h1 class="text-base font-bold">üõ†Ô∏è ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï (AI)</h1>
                <p class="text-xs opacity-90">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
              </header>

              <div id="chat-output" class="flex-1 p-3 flex flex-col space-y-2 overflow-y-auto bg-gray-50"></div>

              <div class="p-3 border-t bg-white">
                <div class="flex flex-col gap-3">
                  <textarea id="user-input" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï..." class="w-full p-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500"></textarea>
                  <button id="analyzeBtn" type="button" class="w-full py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold text-lg shadow">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                  <button id="reportCorruptionBtn" type="button" class="w-full py-3 rounded-2xl bg-green-600 hover:bg-green-700 text-white font-extrabold text-lg shadow hidden opacity-50" disabled>‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="locationInfo" class="mt-2 hidden text-sm text-gray-700 bg-green-50 border border-green-100 rounded-xl p-3">
          <div id="coordinates" class="font-medium"></div>
          <div id="geoText" class="text-xs text-gray-600 mt-1"></div>
        </div>

      </form>

    </section>

    <!-- hidden AI results inputs -->
    <input id="villageField" name="village_ai" type="hidden" />
    <input id="provinceField" name="province_ai" type="hidden" />
    <input id="districtField" name="district_ai" type="hidden" />
    <input id="subdistrictField" name="subdistrict_ai" type="hidden" />

    <!-- Popup ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI -->
    <div id="aiResultPopup" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
  <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-[0_10px_30px_rgba(0,0,0,0.15)] text-center border border-gray-200 animate-fadeIn">
    <h3 class="text-xl font-extrabold mb-3 text-indigo-700">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö AI</h3>
    <p id="aiResultText" class="text-gray-800 leading-relaxed mb-6"></p>
    <button id="closeAiPopup" class="px-6 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-md transition-all">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>
<style>
@keyframes fadeIn { from { opacity:0; transform:scale(.9);} to {opacity:1; transform:scale(1);} }
.animate-fadeIn { animation: fadeIn .25s ease-out; }
</style>
    </div>

  </main>

  <div id="modalRoot"></div>
  <div id="toast" class="toast bg-black/80 rounded-xl"></div>

<script>
// -------------------------
// Helper UI & init
// -------------------------
function generateCaseId(){
  const timePart = Date.now().toString(36).toUpperCase();
  const rnd = Math.random().toString(36).substring(2,8).toUpperCase();
  return 'CASE-' + timePart.slice(-6) + '-' + rnd.slice(0,4);
}

function showToast(msg, ms = 3000){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), ms);
}

function showAiPopup(message){
  document.getElementById('aiResultText').innerHTML = message;
  document.getElementById('aiResultPopup').classList.remove('hidden');
}

// -------------------------
// DOM Ready init
// -------------------------
document.addEventListener('DOMContentLoaded', function(){
  // Case ID
  const display = document.getElementById('caseIdDisplay');
  const input = document.getElementById('caseIdInput');
  if(display && input){
    const id = generateCaseId();
    display.value = id;
    input.value = id;
    display.setAttribute('readonly','readonly');
  }

  // Copy case id
  const copyBtn = document.getElementById('copyCaseIdBtn');
  if(copyBtn){
    copyBtn.addEventListener('click', ()=>{
      navigator.clipboard?.writeText(document.getElementById('caseIdDisplay').value);
      showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
    });
  }

  // Show/hide name & phone
  const radioYes = document.querySelector('input[name="identify"][value="yes"]');
  const radioNo  = document.querySelector('input[name="identify"][value="no"]');
  const nameField = document.getElementById('inputName').closest('div');
  const phoneField = document.getElementById('inputPhone').closest('div');

  function updateVisibility(){
    if(radioNo.checked){
      nameField.classList.add('hidden');
      phoneField.classList.add('hidden');
      document.getElementById('inputName').required = false;
      document.getElementById('inputPhone').required = false;
    } else {
      nameField.classList.remove('hidden');
      phoneField.classList.remove('hidden');
      document.getElementById('inputName').required = true;
      document.getElementById('inputPhone').required = true;
    }
  }

  if(radioYes && radioNo){
    radioYes.addEventListener('change', updateVisibility);
    radioNo.addEventListener('change', updateVisibility);
    // init
    // init
    const formContainer = document.getElementById('emergencyForm');
    formContainer.classList.add('hidden');
    function toggleForm(){ formContainer.classList.remove('hidden'); }
    radioYes.addEventListener('change', toggleForm);
    radioNo.addEventListener('change', toggleForm);
    updateVisibility();
  }

  // Close popup
  document.getElementById('closeAiPopup').addEventListener('click', ()=>{
    document.getElementById('aiResultPopup').classList.add('hidden');
  });

  // Attach analyze button
  const analyzeBtn = document.getElementById('analyzeBtn');
  if(analyzeBtn){
    analyzeBtn.addEventListener('click', analyzeCorruptionDetails);
  }

  // Attach location blur
  // removed old locationText reference (no textarea now);
  if(locationText){
    locationText.addEventListener('blur', analyzeLocationWithAI);
  }
});

</script>

<script>
// -------------------------
// AI analyze flow (frontend -> Supabase Edge Function)
// -------------------------
let aiChecked = false;
let aiIsNACC = false;

async function analyzeCorruptionDetails(){
  const inputEl = document.getElementById('user-input');
  const outputBox = document.getElementById('chat-output');
  const reportBtn = document.getElementById('reportCorruptionBtn');

  if(!inputEl || !outputBox || !reportBtn) return;

  const input = inputEl.value.trim();
  aiChecked = false; aiIsNACC = false;
  reportBtn.disabled = true; reportBtn.classList.add('opacity-50');

  if(!input) {
    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');
    return;
  }

  // Show user message in chat
  const userMsg = document.createElement('div');
  userMsg.className = 'p-2 bg-gray-200 rounded-xl self-end';
  userMsg.textContent = input;
  outputBox.appendChild(userMsg);
  outputBox.scrollTop = outputBox.scrollHeight;

  try{
    const res = await fetch('https://ylbklwrgbgmlrvknmmbn.supabase.co/functions/v1/analyze-nacc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        text: input,
        village: document.getElementById('villageField').value || "",
        subdistrict: document.getElementById('subdistrictField').value || "",
        district: document.getElementById('districtField').value || "",
        province: document.getElementById('provinceField').value || ""
      })
    });

    if(!res.ok){
      const txt = await res.text();
      const errMsg = `‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${res.status} ${txt}`;
      const botErr = document.createElement('div'); botErr.className='p-2 rounded-xl bg-red-200'; botErr.textContent = errMsg; outputBox.appendChild(botErr);
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API');
      return;
    }

    const ai = await res.json();

    // Expect ai to be an object like { is_nacc_responsibility: true, message: '...' }
    aiChecked = true;
    aiIsNACC = ai.is_nacc_responsibility === true;

    const botMsg = document.createElement('div');
    botMsg.className = 'p-2 rounded-xl';
    botMsg.textContent = ai.reason || ai.reason || ai.message || JSON.stringify(ai);
    botMsg.classList.add(aiIsNACC ? 'bg-green-200' : 'bg-red-200');
    outputBox.appendChild(botMsg);
    outputBox.scrollTop = outputBox.scrollHeight;

    // Enable report button only if AI says it's NACC responsibility
    if(aiIsNACC){ 
      reportBtn.disabled = false; 
      reportBtn.classList.remove('opacity-50');
      reportBtn.classList.remove('hidden');
    } reportBtn.classList.remove('opacity-50'); }

    // Show popup with detected location fields (if any)
    const village = document.getElementById('villageField').value || '-';
    const subdistrict = document.getElementById('subdistrictField').value || '-';
    const district = document.getElementById('districtField').value || '-';
    const province = document.getElementById('provinceField').value || '-';

    const userLocation = `${document.getElementById('villageInput').value || ''} ${document.getElementById('subdistrictInput').value || ''} ${document.getElementById('districtInput').value || ''} ${document.getElementById('provinceInput').value || ''}`.trim();

    const locationText = aiIsNACC
      ? `<span class='text-green-700 font-bold text-lg'>‚úî ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏õ.‡∏õ.‡∏ä</span><br>
         <span class='text-gray-800'>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</span><br>
         <span class='text-gray-700'>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏: <b>${userLocation}</b></span><br>
         <span class='text-gray-700'>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô: <b>${village}</b></span><br>
         <span class='text-gray-700'>‡∏ï‡∏≥‡∏ö‡∏•: <b>${subdistrict}</b></span><br>
         <span class='text-gray-700'>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: <b>${district}</b></span><br>
         <span class='text-gray-700'>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: <b>${province}</b></span>`
      : `<span class='text-red-700 font-bold text-lg'>‚úñ ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏õ.‡∏õ.‡∏ä</span><br>
         <span class='text-gray-700'>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏: <b>${userLocation}</b></span>`;

    showAiPopup(locationText);

  }catch(err){
    const botErr = document.createElement('div'); botErr.className='p-2 rounded-xl bg-red-200'; botErr.textContent = `Error: ${err.message}`; outputBox.appendChild(botErr);
    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');
  }
}

// -------------------------
// Location extraction (frontend -> Supabase extract-location function)
// -------------------------
async function analyzeLocationWithAI(){
  const text = document.getElementById('locationText')?.value?.trim();
  if(!text) return;

  try{
    const res = await fetch('https://ylbklwrgbgmlrvknmmbn.supabase.co/functions/v1/extract-location', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });

    if(!res.ok) return;
    const data = await res.json();

    document.getElementById('provinceField').value = data.province || '';
    document.getElementById('districtField').value = data.district || '';
    document.getElementById('subdistrictField').value = data.subdistrict || '';
    document.getElementById('villageField').value = data.village || '';
  }catch(err){
    console.warn('extract-location failed', err);
  }
}

</script>

</body>
</html>
