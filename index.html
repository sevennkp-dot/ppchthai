<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≤‡∏∞‡πÅ‡∏™‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{--bg:#f5f7fa;--primary:#1E3A8A;--accent:#0EA5E9;}
    html,body{height:100%;}
    body{background:linear-gradient(180deg,#f8fafc 0%, #fff 100%);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,'Helvetica Neue',Arial;}
    .loading{display:inline-block;width:18px;height:18px;border:3px solid #f3f3f3;border-top:3px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(-10px);top:18px;z-index:60;padding:10px 16px;border-radius:10px;color:white;font-weight:600;opacity:0;transition:all .28s ease;backdrop-filter: blur(4px)}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
    body { display: flex; flex-direction: column; min-height: 100vh; }
  </style>
</head>
<body class="min-h-screen text-gray-800">

  <main class="w-full max-w-full md:max-w-2xl mx-auto p-4">

    <!-- Top header / brand -->
    <header class="mt-3 mb-3 flex items-center gap-3 w-full">
      <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-3xl bg-[000000] flex items-center justify-center shadow-md">
        <img src="https://ylbklwrgbgmlrvknmmbn.supabase.co/storage/v1/object/sign/pic/Emblem_of_the_National_Anti-Corruption_Commission_Thailand.svg-removebg-preview%20(1).png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9hMWVmYzFiMC1lMDA1LTQ1MzEtYTFkZS0yYjBlY2E3YzI4NmYiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJwaWMvRW1ibGVtX29mX3RoZV9OYXRpb25hbF9BbnRpLUNvcnJ1cHRpb25fQ29tbWlzc2lvbl9UaGFpbGFuZC5zdmctcmVtb3ZlYmctcHJldmlldyAoMSkucG5nIiwiaWF0IjoxNzY0MzMzODEyLCJleHAiOjMxNTUzMzI3OTc4MTJ9.yRIFZXWd3OrA4iEKf_SQ20IfrJC2mrwaQ7GpPQ0_g6w" class="w-12 h-12 sm:w-16 sm:h-16 object-contain" alt="logo"/>
      </div>
      <div class="flex-1">
        <h1 class="text-lg sm:text-xl font-extrabold leading-tight">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏õ.‡∏õ.‡∏ä</h1>
        <p class="text-xs sm:text-sm text-gray-600 leading-tight">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏≤‡∏ö‡∏õ‡∏£‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</p>
      </div>
    </header>

    <!-- Primary card: emergency form -->
    <section id="reportCard" class="bg-white rounded-3xl shadow-xl border border-gray-200 p-6 mb-6 transition-all duration-300">
      <div class="mb-4">
        <h2 class="text-lg font-bold">‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏¥</h2>
        <p class="text-sm text-gray-600 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
      </div>

      <div class="p-3 sm:p-4 rounded-2xl bg-gray-50 border border-gray-200 shadow-sm">
        <!-- Case ID Display -->
        <div class="mt-0 mb-4 p-4 bg-blue-50 border border-blue-300 rounded-2xl shadow-sm">
          <label class="block text-sm font-semibold text-blue-900">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
          <div class="flex items-center gap-2 mt-2">
            <input id="caseIdDisplay" type="text" readonly class="flex-1 rounded-xl border px-4 py-2 bg-white font-semibold text-blue-700 shadow-sm" />
            <button type="button" id="copyCaseIdBtn" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
          </div>
          <input type="hidden" id="caseIdInput" name="case_id" />
        </div>

        <span class="block text-sm font-semibold text-gray-800">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà <span class="text-red-600">*</span></span>
        <div class="mt-2 flex flex-col gap-2">
          <label class="inline-flex items-center gap-2">
            <input id="identifyYes" type="radio" name="identify" value="yes" class="w-4 h-4">
            <span>‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input id="identifyNo" type="radio" name="identify" value="no" class="w-4 h-4">
            <span>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</span>
          </label>
        </div>
      </div>

      <!-- All other form fields are hidden until user chooses identify option -->
      <div id="extraFields" class="hidden">
        <form id="emergencyForm" class="space-y-6 animate-fadeIn" novalidate>

          <div>
            <label for="inputName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-600">*</span></label>
            <input id="inputName" name="name" type="text" class="mt-1 block w-full rounded-2xl border px-4 py-3 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#1E3A8A]" placeholder="‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
          </div>

          <div>
            <label for="inputPhone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="text-red-600">*</span></label>
            <input id="inputPhone" name="phone" type="tel" inputmode="tel" pattern="[0-9+()\s-]{6,}" class="mt-1 block w-full rounded-2xl border px-4 py-3 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#1E3A8A]" placeholder="08x-xxx-xxxx">
            <p class="text-red-600 text-sm mt-1 font-bold">** ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ **</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô/‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î) <span class="text-red-600">*</span></label>
            <div class="mt-2 grid grid-cols-1 gap-3 sm:grid-cols-2">
              <div>
                <label class="block text-xs font-medium text-gray-600">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô <span class="text-red-600">*</span></label>
                <input id="villageInput" name="village" type="text" required class="mt-1 block w-full rounded-2xl border px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600">‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á <span class="text-red-600">*</span></label>
                <input id="subdistrictInput" name="subdistrict" type="text" required class="mt-1 block w-full rounded-2xl border px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï <span class="text-red-600">*</span></label>
                <input id="districtInput" name="district" type="text" required class="mt-1 block w-full rounded-2xl border px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="text-red-600">*</span></label>
                <input id="provinceInput" name="province" type="text" required class="mt-1 block w-full rounded-2xl border px-3 py-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà">
              </div>
            </div>
          </div>

          <!-- OpenAI Chatbot UI integrated -->
          <div>
            <label class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï (‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå)<span class="text-red-600">*</span></label>

            <div id="aiChatContainer" class="mt-3 w-full rounded-2xl border shadow-md overflow-hidden">
              <div class="w-full bg-white rounded-xl overflow-hidden flex flex-col h-[420px] sm:h-[520px]">
                <header class="p-4 bg-indigo-600 text-white shadow-md">
                  <h1 class="text-base font-bold">üõ†Ô∏è ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï (AI)</h1>
                  <p class="text-xs opacity-90">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                </header>

                <div id="chat-output" class="flex-1 p-3 flex flex-col space-y-2 overflow-y-auto bg-gray-50"></div>

                <div class="p-3 border-t bg-white">
                  <div class="flex flex-col gap-3">
                    <textarea id="user-input" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï..." class="w-full p-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500"></textarea>
                    <button id="analyzeBtn" type="button" class="w-full py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold text-lg shadow">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>

                    <!-- Upload area: hidden until AI says it's NACC responsibility -->
                    <div id="uploadArea" class="hidden mt-3">
                      <div class="flex gap-2">
                        <button id="chooseFilesBtn" type="button" class="flex-1 py-2 rounded-lg border border-dashed border-gray-300 bg-white hover:bg-gray-50">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</button>
                        <button id="reportCorruptionBtn" type="button" class="w-40 py-2 rounded-2xl bg-green-600 hover:bg-green-700 text-white font-extrabold text-lg shadow opacity-50" disabled>‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï</button>
                      </div>
                      <input id="fileInput" type="file" class="hidden" multiple />

                      <div id="filesGridWrap" class="mt-3">
                        <div id="filesGrid" class="grid grid-cols-2 sm:grid-cols-5 gap-3"></div>
                        <p id="filesHelp" class="text-xs text-gray-500 mt-2">‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î 5 ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß ‚Äî ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="locationInfo" class="mt-2 hidden text-sm text-gray-700 bg-green-50 border border-green-100 rounded-xl p-3">
            <div id="coordinates" class="font-medium"></div>
            <div id="geoText" class="text-xs text-gray-600 mt-1"></div>
          </div>

        </form>
      </div>

    </section>

    <!-- hidden AI results inputs -->
    <input id="villageField" name="village_ai" type="hidden" />
    <input id="provinceField" name="province_ai" type="hidden" />
    <input id="districtField" name="district_ai" type="hidden" />
    <input id="subdistrictField" name="subdistrict_ai" type="hidden" />

    <!-- Popup ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI -->
    <div id="aiResultPopup" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl text-center">
        <h3 class="text-lg font-bold mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö AI</h3>
        <div id="aiResultText" class="text-gray-700 mb-4 text-left"></div>
        <div class="text-center"><button id="closeAiPopup" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">‡∏õ‡∏¥‡∏î</button></div>
      </div>
    </div>

  </main>

  <div id="modalRoot"></div>
  <div id="toast" class="toast bg-black/80 rounded-xl"></div>

<script>
// -------------------------
// Helper UI & init
// -------------------------
function generateCaseId(){
  var timePart = Date.now().toString(36).toUpperCase();
  var rnd = Math.random().toString(36).substring(2,8).toUpperCase();
  return 'CASE-' + timePart.slice(-6) + '-' + rnd.slice(0,4);
}

function showToast(msg, ms) {
  ms = typeof ms === 'number' ? ms : 3000;
  var t = document.getElementById('toast');
  if(!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, ms);
}

function showAiPopup(htmlMessage) {
  var el = document.getElementById('aiResultText');
  var popup = document.getElementById('aiResultPopup');
  if(!el || !popup) return;
  el.innerHTML = htmlMessage;
  popup.classList.remove('hidden');
}

// -------------------------
// DOM Ready init
// -------------------------
document.addEventListener('DOMContentLoaded', function(){
  try{
    var display = document.getElementById('caseIdDisplay');
    var input = document.getElementById('caseIdInput');
    if(display && input){
      var id = generateCaseId();
      display.value = id;
      input.value = id;
      display.setAttribute('readonly','readonly');
    }

    var copyBtn = document.getElementById('copyCaseIdBtn');
    if(copyBtn){
      copyBtn.addEventListener('click', function(){
        try{ navigator.clipboard && navigator.clipboard.writeText && navigator.clipboard.writeText(document.getElementById('caseIdDisplay').value); }
        catch(e){}
        showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
      });
    }

    var radioYes = document.getElementById('identifyYes');
    var radioNo = document.getElementById('identifyNo');
    var extra = document.getElementById('extraFields');
    var nameInput = document.getElementById('inputName');
    var phoneInput = document.getElementById('inputPhone');
    var nameField = nameInput ? nameInput.parentElement : null;
    var phoneField = phoneInput ? phoneInput.parentElement : null;

    function updateVisibility() {
      var yesChecked = radioYes && radioYes.checked;
      var noChecked = radioNo && radioNo.checked;

      if(!yesChecked && !noChecked){
        if(extra) extra.classList.add('hidden');
        if(nameInput) nameInput.required = false;
        if(phoneInput) phoneInput.required = false;
        return;
      }

      if(extra) extra.classList.remove('hidden');

      if(noChecked){
        if(nameField) nameField.classList.add('hidden');
        if(phoneField) phoneField.classList.add('hidden');
        if(nameInput) nameInput.required = false;
        if(phoneInput) phoneInput.required = false;
      } else if(yesChecked){
        if(nameField) nameField.classList.remove('hidden');
        if(phoneField) phoneField.classList.remove('hidden');
        if(nameInput) nameInput.required = true;
        if(phoneInput) phoneInput.required = true;
      }
    }

    if(radioYes) radioYes.addEventListener('change', updateVisibility);
    if(radioNo) radioNo.addEventListener('change', updateVisibility);
    updateVisibility();

    var closeBtn = document.getElementById('closeAiPopup');
    if(closeBtn) closeBtn.addEventListener('click', function(){
      var popup = document.getElementById('aiResultPopup');
      if(popup) popup.classList.add('hidden');
    });

    var analyzeBtn = document.getElementById('analyzeBtn');
    if(analyzeBtn) analyzeBtn.addEventListener('click', analyzeCorruptionDetails);

    var villageInput = document.getElementById('villageInput');
    var subdistrictInput = document.getElementById('subdistrictInput');
    var districtInput = document.getElementById('districtInput');
    var provinceInput = document.getElementById('provinceInput');

    function syncLocationHiddenFields() {
      var vf = document.getElementById('villageField');
      var sf = document.getElementById('subdistrictField');
      var df = document.getElementById('districtField');
      var pf = document.getElementById('provinceField');
      if(vf) vf.value = villageInput ? villageInput.value : '';
      if(sf) sf.value = subdistrictInput ? subdistrictInput.value : '';
      if(df) df.value = districtInput ? districtInput.value : '';
      if(pf) pf.value = provinceInput ? provinceInput.value : '';
    }

    [villageInput, subdistrictInput, districtInput, provinceInput].forEach(function(el){
      if(!el) return;
      el.addEventListener('input', syncLocationHiddenFields);
      el.addEventListener('blur', analyzeLocationWithAI);
    });

  }catch(e){
    console.error('init error', e);
  }
});

</script>

<script>
// -------------------------
// AI analyze flow (frontend -> Supabase Edge Function)
// -------------------------
var aiChecked = false;
var aiIsNACC = false;

async function analyzeCorruptionDetails(){
  var inputEl = document.getElementById('user-input');
  var outputBox = document.getElementById('chat-output');
  var reportBtn = document.getElementById('reportCorruptionBtn');

  if(!inputEl || !outputBox || !reportBtn) return;

  var input = (inputEl.value || '').trim();
  aiChecked = false; aiIsNACC = false;
  reportBtn.disabled = true; reportBtn.classList.add('opacity-50');

  if(!input) {
    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');
    return;
  }

  // Show user message in chat
  var userMsg = document.createElement('div');
  userMsg.className = 'p-2 bg-gray-200 rounded-xl self-end';
  userMsg.textContent = input;
  outputBox.appendChild(userMsg);
  outputBox.scrollTop = outputBox.scrollHeight;

  try{
    var res = await fetch('https://ylbklwrgbgmlrvknmmbn.supabase.co/functions/v1/analyze-nacc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        text: input,
        village: (document.getElementById('villageField') && document.getElementById('villageField').value) || "",
        subdistrict: (document.getElementById('subdistrictField') && document.getElementById('subdistrictField').value) || "",
        district: (document.getElementById('districtField') && document.getElementById('districtField').value) || "",
        province: (document.getElementById('provinceField') && document.getElementById('provinceField').value) || ""
      })
    });

    if(!res.ok){
      var txt = await res.text();
      var errMsg = '‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + res.status + ' ' + txt;
      var botErr = document.createElement('div'); botErr.className='p-2 rounded-xl bg-red-200'; botErr.textContent = errMsg; outputBox.appendChild(botErr);
      showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API');
      return;
    }

    var ai = await res.json();

    aiChecked = true;
    aiIsNACC = ai && ai.is_nacc_responsibility === true;

    var botMsg = document.createElement('div');
    botMsg.className = 'p-2 rounded-xl';
    botMsg.textContent = ai && (ai.reason || ai.message) ? (ai.reason || ai.message) : JSON.stringify(ai);
    botMsg.classList.add(aiIsNACC ? 'bg-green-200' : 'bg-red-200');
    outputBox.appendChild(botMsg);
    outputBox.scrollTop = outputBox.scrollHeight;

    if(aiIsNACC){
      reportBtn.disabled = false;
      reportBtn.classList.remove('opacity-50');
      reportBtn.classList.remove('hidden');
      // show upload area when analyzed as NACC responsibility
      var uploadArea = document.getElementById('uploadArea');
      if(uploadArea){ uploadArea.classList.remove('hidden'); }
    } else {
      reportBtn.disabled = true;
      reportBtn.classList.add('opacity-50');
      reportBtn.classList.add('hidden');
      var uploadArea = document.getElementById('uploadArea');
      if(uploadArea){ uploadArea.classList.add('hidden'); }
    }

    var village = (document.getElementById('villageField') && document.getElementById('villageField').value) || '-';
    var subdistrict = (document.getElementById('subdistrictField') && document.getElementById('subdistrictField').value) || '-';
    var district = (document.getElementById('districtField') && document.getElementById('districtField').value) || '-';
    var province = (document.getElementById('provinceField') && document.getElementById('provinceField').value) || '-';

    var v = (document.getElementById('villageInput') && document.getElementById('villageInput').value) || '-';
    var s = (document.getElementById('subdistrictInput') && document.getElementById('subdistrictInput').value) || '-';
    var d = (document.getElementById('districtInput') && document.getElementById('districtInput').value) || '-';
    var p = (document.getElementById('provinceInput') && document.getElementById('provinceInput').value) || '-';

    var userLocation = v + ', ' + s + ', ' + d + ', ' + p;

    var htmlPieces = [];
    if(aiIsNACC){
      htmlPieces.push('<div style="color:#166534;font-weight:700;font-size:18px;">‚úî ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏õ.‡∏õ.‡∏ä</div>');
      htmlPieces.push('<div style="margin-top:6px;color:#374151;font-weight:600;">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</div>');
      // show individual fields, but DO NOT show the full concatenated userLocation line
      htmlPieces.push('<div style="color:#374151;margin-top:6px;">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô: <b>' + village + '</b></div>');
      htmlPieces.push('<div style="color:#374151;">‡∏ï‡∏≥‡∏ö‡∏•: <b>' + subdistrict + '</b></div>');
      htmlPieces.push('<div style="color:#374151;">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: <b>' + district + '</b></div>');
      htmlPieces.push('<div style="color:#374151;">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: <b>' + province + '</b></div>');
    } else {
      htmlPieces.push('<div style="color:#B91C1C;font-weight:700;font-size:18px;">‚úñ ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏õ.‡∏õ.‡∏ä</div>');
      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
    }

    showAiPopup(htmlPieces.join('\n'));

  }catch(err){
    var botErr = document.createElement('div'); botErr.className='p-2 rounded-xl bg-red-200'; botErr.textContent = 'Error: ' + (err && err.message ? err.message : String(err)); outputBox.appendChild(botErr);
    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');
  }
}

// -------------------------
// Location extraction (frontend -> Supabase extract-location function)
// -------------------------
async function analyzeLocationWithAI(){
  var v = (document.getElementById('villageInput') && document.getElementById('villageInput').value) || '';
  var s = (document.getElementById('subdistrictInput') && document.getElementById('subdistrictInput').value) || '';
  var d = (document.getElementById('districtInput') && document.getElementById('districtInput').value) || '';
  var p = (document.getElementById('provinceInput') && document.getElementById('provinceInput').value) || '';
  var text = [v,s,d,p].filter(function(x){ return x && x.trim(); }).join(', ');
  if(!text) return;

  try{
    var res = await fetch('https://ylbklwrgbgmlrvknmmbn.supabase.co/functions/v1/extract-location', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: text })
    });

    if(!res.ok) return;
    var data = await res.json();

    var pf = document.getElementById('provinceField'); if(pf) pf.value = data.province || '';
    var df = document.getElementById('districtField'); if(df) df.value = data.district || '';
    var sf = document.getElementById('subdistrictField'); if(sf) sf.value = data.subdistrict || '';
    var vf = document.getElementById('villageField'); if(vf) vf.value = data.village || '';
  }catch(err){
    console.warn('extract-location failed', err);
  }
}

</script>


<script>
// File upload UI logic (supports multiple selections, multiple times, grid 5-per-row)
(function(){
  var uploadedFiles = []; // {id, file, url}
  var chooseBtn = document.getElementById('chooseFilesBtn');
  var fileInput = document.getElementById('fileInput');
  var filesGrid = document.getElementById('filesGrid');
  var reportBtn = document.getElementById('reportCorruptionBtn');

  function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    var k = 1024, sizes = ['B', 'KB', 'MB', 'GB', 'TB'], i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function renderFiles(){
    if(!filesGrid) return;
    filesGrid.innerHTML = '';
    uploadedFiles.forEach(function(item, idx){
      var f = item.file;
      var tile = document.createElement('div');
      tile.className = 'relative border border-gray-300 rounded-lg p-2 bg-white flex flex-col items-center justify-start text-xs';
      tile.style.minHeight = '60px';

      var thumbWrap = document.createElement('div');
      thumbWrap.className = 'w-full flex items-center justify-center mb-2';
      thumbWrap.style.height = '12px';

      if(item.url){
        var img = document.createElement('img'); img.src = item.url; img.style.maxHeight='12px'; img.style.objectFit='contain'; img.className='rounded';
        thumbWrap.appendChild(img);
      } else {
        var ext = (f.name.split('.').pop() || '').toUpperCase();
        var icon = document.createElement('div'); icon.className='flex items-center justify-center w-full h-full text-sm font-semibold text-gray-600'; icon.textContent = ext || 'FILE';
        thumbWrap.appendChild(icon);
      }

      var nameEl = document.createElement('div'); nameEl.className='truncate text-center w-full'; nameEl.title = f.name; nameEl.textContent = f.name;
      var sizeEl = document.createElement('div'); sizeEl.className='text-[11px] text-gray-400 mt-1'; sizeEl.textContent = formatBytes(f.size);

      var removeBtn = document.createElement('button'); removeBtn.type='button'; removeBtn.className='absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center'; removeBtn.textContent='√ó';
      removeBtn.addEventListener('click', function(e){ e.preventDefault(); removeFile(idx); });

      tile.appendChild(removeBtn);
      tile.appendChild(thumbWrap);
      tile.appendChild(nameEl);
      tile.appendChild(sizeEl);
      filesGrid.appendChild(tile);
    });

    // enable/disable report button depending on whether we require files
    // keep report button enabled as soon as AI marks NACC responsibility
    // optionally show count
    var help = document.getElementById('filesHelp');
    if(help) help.textContent = '‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î ' + (uploadedFiles.length ? ('(' + uploadedFiles.length + ')') : '') + ' ‚Äî 5 ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß ‚Äî ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
  }

  function removeFile(index){
    if(index < 0 || index >= uploadedFiles.length) return;
    var it = uploadedFiles[index];
    if(it.url) URL.revokeObjectURL(it.url);
    uploadedFiles.splice(index,1);
    renderFiles();
  }

  if(chooseBtn){
    chooseBtn.addEventListener('click', function(){ if(fileInput) fileInput.click(); });
  }

  if(fileInput){
    fileInput.addEventListener('change', function(e){
      var files = Array.prototype.slice.call(e.target.files || []);
      files.forEach(function(f){
        var id = Date.now().toString(36) + Math.random().toString(36).substring(2,6);
        var url = null;
        try{ if(f.type && f.type.indexOf('image/') === 0) url = URL.createObjectURL(f); }catch(err){ url = null; }
        uploadedFiles.push({ id: id, file: f, url: url });
      });
      renderFiles();
      // reset so same file can be selected again later
      fileInput.value = '';
    });
  }

  // Expose function to get files when submitting report
  window.getUploadedFilesForReport = function(){ return uploadedFiles.map(function(it){ return it.file; }); };

})();
</script>

</body>
</html>
